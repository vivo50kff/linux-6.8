#!/bin/sh
mount -t proc none /proc 2>/dev/null || true
mount -t sysfs none /sys 2>/dev/null || true

# 挂载debugfs
mount -t debugfs none /sys/kernel/debug

echo "=== 配置ftrace追踪（修复版）==="

# 首先清理所有追踪设置
echo 0 > /sys/kernel/debug/tracing/tracing_on
echo nop > /sys/kernel/debug/tracing/current_tracer
echo > /sys/kernel/debug/tracing/set_ftrace_filter
echo > /sys/kernel/debug/tracing/set_ftrace_notrace

# 设置不追踪的函数（避免递归和RCU问题）
echo '*idle*' > /sys/kernel/debug/tracing/set_ftrace_notrace
echo '*rcu*' >> /sys/kernel/debug/tracing/set_ftrace_notrace
echo '*ftrace*' >> /sys/kernel/debug/tracing/set_ftrace_notrace
echo '*trace*' >> /sys/kernel/debug/tracing/set_ftrace_notrace

# 设置追踪缓冲区大小
echo 4096 > /sys/kernel/debug/tracing/buffer_size_kb

# 使用function追踪器而非function_graph（减少递归风险）
echo function > /sys/kernel/debug/tracing/current_tracer

# 只追踪我们的YAT调度器函数
echo 'enqueue_task_yat_casched' > /sys/kernel/debug/tracing/set_ftrace_filter
echo 'dequeue_task_yat_casched' >> /sys/kernel/debug/tracing/set_ftrace_filter
echo 'pick_next_task_yat_casched' >> /sys/kernel/debug/tracing/set_ftrace_filter
echo 'select_task_rq_yat_casched' >> /sys/kernel/debug/tracing/set_ftrace_filter

# 启用调度事件追踪（更安全的方式）
echo 1 > /sys/kernel/debug/tracing/events/sched/sched_switch/enable
echo 1 > /sys/kernel/debug/tracing/events/sched/sched_wakeup/enable

echo "ftrace配置完成，开始测试..."

# 开始追踪
echo 1 > /sys/kernel/debug/tracing/tracing_on

echo "=== 启动TACLEBENCH kernel任务集测试 ==="
/bin/tacle_kernel_test

# 停止追踪
echo 0 > /sys/kernel/debug/tracing/tracing_on

echo "=== 测试完成，ftrace结果："
echo "查看追踪结果: cat /sys/kernel/debug/tracing/trace"
echo "查看追踪统计: cat /sys/kernel/debug/tracing/trace_stat/function*"

exec /bin/sh
