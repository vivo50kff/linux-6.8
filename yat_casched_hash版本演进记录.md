# Yat_Casched å†³èµ›ç‰ˆå…¨å±€ç¼“å­˜æ„ŸçŸ¥è°ƒåº¦å™¨æ¼”è¿›è®°å½•

## ç‰ˆæœ¬æ¼”è¿›

### åˆèµ›ç‰ˆæœ¬ï¼ˆBaselineï¼‰
- **è®¾è®¡æ€è·¯**: ä»…å®ç°"last_cpu"äº²å’Œæ€§ï¼Œæ¯æ¬¡å”¤é†’ä¼˜å…ˆæ”¾å›ä¸Šæ¬¡è¿è¡Œçš„CPU
- **ç‰¹ç‚¹**: ä»»åŠ¡è°ƒåº¦å®Œå…¨æœ¬åœ°åŒ–ï¼Œæ— å…¨å±€è§†è§’
- **æ•°æ®ç»“æ„**: ç®€å•çš„CPUå†å²è¡¨ï¼Œè®°å½•ä»»åŠ¡â†’CPUæ˜ å°„

### å†³èµ›ç‰ˆæœ¬ï¼ˆCurrentï¼‰
- **è®¾è®¡æ€è·¯**: é‡‡ç”¨LCIFæ€æƒ³çš„å…¨å±€ç¼“å­˜æ„ŸçŸ¥è°ƒåº¦
- **ç‰¹ç‚¹**: "å…¨å±€ä¼˜å…ˆé˜Ÿåˆ—+åŠ é€Ÿè¡¨"ä¸¤å±‚ç»“æ„ï¼Œå…¼é¡¾å…¨å±€æœ€ä¼˜ä¸é«˜æ•ˆå®ç°
- **æ•°æ®ç»“æ„**: å…¨å±€ä¼˜å…ˆé˜Ÿåˆ—ã€äºŒç»´åŠ é€Ÿè¡¨ã€CPUå†å²è¡¨

## å†³èµ›ç‰ˆæ ¸å¿ƒæœºåˆ¶

### 1. å…¨å±€ä¼˜å…ˆé˜Ÿåˆ—
- æ‰€æœ‰å¾…è°ƒåº¦ä»»åŠ¡ç»Ÿä¸€ç»´æŠ¤åœ¨`yat_global_task_pool`ä¸­
- é˜Ÿåˆ—æ’åºè§„åˆ™ï¼šä¼˜å…ˆçº§é«˜è€…åœ¨å‰ï¼Œä¼˜å…ˆçº§ç›¸åŒåˆ™WCETå¤§è€…åœ¨å‰
- æ¯æ¬¡è°ƒåº¦å¾ªç¯åªå¤„ç†é˜Ÿå¤´ä»»åŠ¡

### 2. åŠ é€Ÿè¡¨ï¼ˆäºŒç»´å“ˆå¸Œè¡¨ï¼‰
- è®¾è®¡`accel_table[task][cpu]`ï¼Œæ”¯æŒ(task,cpu)â†’benefitæŸ¥æ‰¾
- è¡¨é¡¹å­˜å‚¨ï¼šç»™å®šä»»åŠ¡ç¼–å·å’Œæ ¸å¿ƒç¼–å·ï¼Œè¿”å›è¯¥ä»»åŠ¡åˆ†é…åˆ°è¯¥æ ¸å¿ƒçš„åŠ é€Ÿå€¼
- benefitè®¡ç®—ï¼š`benefit = (1 - crp_ratio) * WCET`

### 3. ajlrè°ƒåº¦ä¸»æµç¨‹
```
while (!yat_global_task_pool.empty()) {
    task = yat_global_task_pool.top();
    best_cpu = find_best_cpu_with_max_benefit(task);
    if (best_cpu != -1) {
        assign(task, best_cpu);
        yat_global_task_pool.pop();
        update_accel_table();
    } else {
        break;
    }
}
```

## æ•°æ®ç»“æ„å¯¹æ¯”

### åŸæœ‰ç»“æ„ï¼ˆä¿ç•™å…¼å®¹ï¼‰
```c
struct yat_task_history_entry {
    struct hlist_node hash_node;
    pid_t pid;
    u64 exec_time;
    u64 last_update_time;
};

struct yat_cpu_history {
    struct hlist_head *task_hash;
    spinlock_t lock;
    u64 last_cleanup_time;
};
```

### æ–°å¢æ ¸å¿ƒç»“æ„
```c
// åŠ é€Ÿè¡¨æ¡ç›®
struct yat_accel_entry {
    struct hlist_node hash_node;
    pid_t task_pid;
    int cpu_id;
    u64 benefit;                   // æ ¸å¿ƒï¼šåŠ é€Ÿå€¼
    u64 wcet;                      // ä»»åŠ¡WCET
    u64 crp_ratio;                 // CRPæ¯”ç‡
    u64 last_update_time;
};

// å…¨å±€ä¼˜å…ˆé˜Ÿåˆ—èŠ‚ç‚¹
struct yat_global_task_node {
    struct list_head list;
    struct task_struct *task;
    int priority;                  // æ ¸å¿ƒï¼šä»»åŠ¡ä¼˜å…ˆçº§
    u64 wcet;                      // æ ¸å¿ƒï¼šWCETå€¼
    u64 enqueue_time;
};

// CPUå†å²è¡¨ï¼ˆæ—¶é—´æˆ³â†’ä»»åŠ¡æ˜ å°„ï¼‰
struct yat_history_entry {
    struct hlist_node hash_node;
    u64 timestamp;                 // æ ¸å¿ƒï¼šç²¾ç¡®æ—¶é—´æˆ³
    struct task_struct *task;
    u64 insert_time;
};
```

### å¢å¼ºçš„ä»»åŠ¡å®ä½“
```c
struct sched_yat_casched_entity {
    // åŸæœ‰å­—æ®µ
    struct list_head run_list;
    u64 vruntime;
    u64 slice;
    int last_cpu;
    
    // æ–°å¢å­—æ®µ
    u64 per_cpu_recency[NR_CPUS];  // æ ¸å¿ƒï¼šæ¯CPUçš„recencyå€¼
    u64 wcet;                      // æ ¸å¿ƒï¼šä»»åŠ¡WCET
    int priority;                  // æ ¸å¿ƒï¼šä»»åŠ¡ä¼˜å…ˆçº§
};
```

# Yat_Casched å†³èµ›ç‰ˆå…¨å±€ç¼“å­˜æ„ŸçŸ¥è°ƒåº¦å™¨æ¼”è¿›è®°å½•

## ç‰ˆæœ¬æ¼”è¿›

### åˆèµ›ç‰ˆæœ¬ï¼ˆBaselineï¼‰
- **è®¾è®¡æ€è·¯**: ä»…å®ç°"last_cpu"äº²å’Œæ€§ï¼Œæ¯æ¬¡å”¤é†’ä¼˜å…ˆæ”¾å›ä¸Šæ¬¡è¿è¡Œçš„CPU
- **ç‰¹ç‚¹**: ä»»åŠ¡è°ƒåº¦å®Œå…¨æœ¬åœ°åŒ–ï¼Œæ— å…¨å±€è§†è§’
- **æ•°æ®ç»“æ„**: ç®€å•çš„CPUå†å²è¡¨ï¼Œè®°å½•ä»»åŠ¡â†’CPUæ˜ å°„

### è¿‡æ¸¡ç‰ˆæœ¬ï¼ˆå·²å¼ƒç”¨ï¼‰
- **é—ç•™ç»“æ„**: `struct yat_task_history_entry` å’Œ `struct yat_cpu_history`
- **é—®é¢˜**: ä¸æ–°è®¾è®¡çš„å†å²è¡¨åŠŸèƒ½é‡å¤ï¼Œé€ æˆä»£ç å†—ä½™
- **çŠ¶æ€**: å·²å®Œå…¨ç§»é™¤

### å†³èµ›ç‰ˆæœ¬ï¼ˆCurrent - æ¸…ç†åï¼‰
- **è®¾è®¡æ€è·¯**: é‡‡ç”¨LCIFæ€æƒ³çš„å…¨å±€ç¼“å­˜æ„ŸçŸ¥è°ƒåº¦
- **ç‰¹ç‚¹**: "å…¨å±€ä¼˜å…ˆé˜Ÿåˆ—+åŠ é€Ÿè¡¨"ä¸¤å±‚ç»“æ„ï¼Œå…¼é¡¾å…¨å±€æœ€ä¼˜ä¸é«˜æ•ˆå®ç°
- **æ•°æ®ç»“æ„**: å…¨å±€ä¼˜å…ˆé˜Ÿåˆ—ã€äºŒç»´åŠ é€Ÿè¡¨ã€CPUå†å²è¡¨ï¼ˆç»Ÿä¸€æ¶æ„ï¼‰

## ä»£ç æ¸…ç†è®°å½• (2025å¹´7æœˆ16æ—¥)

### ç§»é™¤çš„é—ç•™ç»“æ„
```c
// å·²åˆ é™¤ - æ—§çš„ä»»åŠ¡å†å²è®°å½•é¡¹
struct yat_task_history_entry {
    struct hlist_node hash_node;
    pid_t pid;
    u64 exec_time;
    u64 last_update_time;
};

// å·²åˆ é™¤ - æ—§çš„CPUå†å²è¡¨
struct yat_cpu_history {
    struct hlist_head *task_hash;
    spinlock_t lock;
    u64 last_cleanup_time;
};
```

### ç§»é™¤çš„å‡½æ•°
- `yat_find_task_entry()` - æŸ¥æ‰¾ç‰¹å®šCPUä¸Šçš„ä»»åŠ¡å†å²è®°å½•
- `yat_update_task_entry()` - æ›´æ–°æˆ–åˆ›å»ºä»»åŠ¡å†å²è®°å½•
- `yat_get_task_exec_time()` - è·å–ä»»åŠ¡åœ¨CPUä¸Šçš„æ‰§è¡Œæ—¶é—´
- `yat_cleanup_cpu_expired_entries()` - æ¸…ç†è¿‡æœŸå†å²è®°å½•
- `yat_find_best_cpu_for_task()` - åŸºäºæ—§å†å²è¡¨çš„CPUé€‰æ‹©

### ç§»é™¤çš„å®å®šä¹‰
- `YAT_CASCHED_HASH_BITS` - æ—§çš„å“ˆå¸Œè¡¨ä½æ•°å®šä¹‰

### æ¸…ç†çš„ç»“æ„å­—æ®µ
```c
struct yat_casched_rq {
    // å·²åˆ é™¤
    // struct yat_cpu_history cpu_history[NR_CPUS];
    
    // ä¿ç•™ - ç»Ÿä¸€çš„æ–°æ¶æ„
    struct yat_global_task_pool *global_pool;
    struct yat_accel_table *accel_table;
    struct yat_cpu_history_table history_tables[NR_CPUS];
};
```

## å½“å‰ç»Ÿä¸€æ¥å£æ¶æ„

### åŠ é€Ÿè¡¨æ¥å£ï¼ˆæ ¸å¿ƒè°ƒåº¦ï¼‰
- `yat_accel_table_init()` - åˆå§‹åŒ–åŠ é€Ÿè¡¨
- `yat_accel_table_insert()` - æ’å…¥(task,cpu)â†’benefitæ˜ å°„
- `yat_accel_table_lookup()` - æŸ¥æ‰¾benefitå€¼ **[æ ¸å¿ƒè°ƒåº¦æ¥å£]**
- `yat_accel_table_update()` - æ›´æ–°benefitå€¼
- `yat_accel_table_delete()` - åˆ é™¤æ˜ å°„å…³ç³»
- `yat_accel_table_cleanup()` - æ¸…ç†è¿‡æœŸæ¡ç›®

### å…¨å±€ä¼˜å…ˆé˜Ÿåˆ—æ¥å£ï¼ˆä»»åŠ¡ç®¡ç†ï¼‰
- `yat_global_pool_init()` - åˆå§‹åŒ–å…¨å±€é˜Ÿåˆ—
- `yat_global_pool_enqueue()` - æŒ‰ä¼˜å…ˆçº§+WCETå…¥é˜Ÿ **[æ ¸å¿ƒè°ƒåº¦æ¥å£]**
- `yat_global_pool_dequeue()` - å–é˜Ÿå¤´ä»»åŠ¡ **[æ ¸å¿ƒè°ƒåº¦æ¥å£]**
- `yat_global_pool_peek()` - æŸ¥çœ‹é˜Ÿå¤´ä»»åŠ¡
- `yat_global_pool_empty()` - æ£€æŸ¥é˜Ÿåˆ—çŠ¶æ€
- `yat_global_pool_remove()` - ç§»é™¤æŒ‡å®šä»»åŠ¡

### å†å²è¡¨æ¥å£ï¼ˆç¼“å­˜åˆ†æï¼‰
- `init_cpu_history_tables()` - åˆå§‹åŒ–æ‰€æœ‰CPUå†å²è¡¨
- `add_history_record()` - æ·»åŠ æ—¶é—´æˆ³â†’ä»»åŠ¡è®°å½• **[ä¸ºimpactåˆ†æé¢„ç•™]**
- `get_history_task()` - æŸ¥è¯¢æŒ‡å®šæ—¶é—´æˆ³çš„ä»»åŠ¡
- `prune_history_table()` - æ¸…ç†è¿‡æœŸå†å²è®°å½•

## è°ƒåº¦ç®—æ³•æ¶æ„ï¼ˆæ¸…ç†åï¼‰

### å½“å‰ç®€åŒ–ç‰ˆæœ¬
```c
int select_task_rq_yat_casched() {
    // å½“å‰ä½¿ç”¨è´Ÿè½½å‡è¡¡ç­–ç•¥
    // TODO: åç»­é›†æˆåŠ é€Ÿè¡¨æŸ¥æ‰¾
    return select_least_loaded_cpu();
}

struct task_struct *pick_next_task_yat_casched() {
    // ç®€å•FIFO + æ–°å†å²è¡¨è®°å½•
    task = get_first_task_from_queue();
    add_history_record(history_tables, cpu, timestamp, task);
    return task;
}
```

### ç›®æ ‡ajlrç®—æ³•æ¶æ„ï¼ˆå¾…å®ç°ï¼‰
```c
// ajlrä¸»è°ƒåº¦å¾ªç¯ï¼ˆå®Œæ•´ç‰ˆæœ¬ï¼‰
while (!yat_global_pool_empty(global_pool)) {
    task = yat_global_pool_peek(global_pool);
    best_cpu = find_best_cpu_with_max_benefit(task);
    
    if (best_cpu != -1) {
        assign_task_to_cpu(task, best_cpu);
        yat_global_pool_dequeue(global_pool);
        
        // æ›´æ–°æ‰€æœ‰è¡¨
        yat_accel_table_update(...);
        add_history_record(...);
    } else {
        break;
    }
}
```

## æ¸…ç†æ•ˆæœ

### ä»£ç ç®€åŒ–
- **åˆ é™¤é‡å¤ä»£ç **: ç§»é™¤äº†ä¸æ–°å†å²è¡¨åŠŸèƒ½é‡å¤çš„æ—§ç»“æ„
- **ç»Ÿä¸€æ¥å£**: æ‰€æœ‰å†å²è®°å½•åŠŸèƒ½ç»Ÿä¸€åˆ°æ–°çš„`yat_cpu_history_table`
- **å‡å°‘ç»´æŠ¤è´Ÿæ‹…**: ä¸å†éœ€è¦ç»´æŠ¤ä¸¤å¥—ç›¸ä¼¼çš„å“ˆå¸Œè¡¨å®ç°

### å†…å­˜ä¼˜åŒ–
- **å»é™¤å†—ä½™**: ä¸å†åŒæ—¶ç»´æŠ¤ä¸¤å¥—CPUå†å²è®°å½•
- **å†…å­˜èŠ‚çœ**: æ¯ä¸ªCPUèŠ‚çœ64ä¸ªæ—§å“ˆå¸Œæ¡¶çš„å¼€é”€
- **æ¶æ„æ¸…æ™°**: å•ä¸€èŒè´£ï¼Œæ¯ä¸ªæ•°æ®ç»“æ„åŠŸèƒ½æ˜ç¡®

### æ€§èƒ½æå‡
- **å‡å°‘é”ç«äº‰**: ä¸å†æœ‰æ—§å†å²è¡¨çš„é¢å¤–é”æ“ä½œ
- **ç¼“å­˜å‹å¥½**: å‡å°‘äº†ä¸å¿…è¦çš„å†…å­˜è®¿é—®
- **ä»£ç è·¯å¾„ç®€åŒ–**: è°ƒåº¦è·¯å¾„æ›´ç›´æ¥ï¼Œå‡å°‘å‡½æ•°è°ƒç”¨å±‚æ¬¡

## å“ˆå¸Œè¡¨æ¶æ„ï¼ˆæ¸…ç†åï¼‰

### ç»Ÿä¸€çš„å“ˆå¸Œä½æ•°é…ç½®
```c
// ç§»é™¤äº†æ—§çš„ YAT_CASCHED_HASH_BITS
#define YAT_ACCEL_HASH_BITS    8   /* 2^8 = 256æ¡¶ï¼ŒåŠ é€Ÿè¡¨ */
#define YAT_HISTORY_HASH_BITS  7   /* 2^7 = 128æ¡¶ï¼Œå†å²è¡¨ */
```

### æ¸…æ™°çš„èŒè´£åˆ†å·¥
- **åŠ é€Ÿè¡¨**: ä¸“æ³¨äº(task,cpu)â†’benefitæ˜ å°„ï¼Œæ”¯æŒè°ƒåº¦å†³ç­–
- **å†å²è¡¨**: ä¸“æ³¨äºæ—¶é—´æˆ³â†’ä»»åŠ¡æ˜ å°„ï¼Œæ”¯æŒimpactåˆ†æ
- **æ— é‡å¤**: æ¯ç§æ•°æ®æœ‰å”¯ä¸€çš„å­˜å‚¨å’Œè®¿é—®æ–¹å¼

## å…¼å®¹æ€§ä¿è¯

### æ¥å£å…¼å®¹
- è°ƒåº¦ç±»æ¥å£å®Œå…¨ä¿æŒä¸å˜
- å¯¹å¤–APIä¿æŒä¸€è‡´
- é…ç½®é€‰é¡¹æ— å˜åŒ–

### åŠŸèƒ½ç­‰ä»·
- æ‰€æœ‰åŸæœ‰åŠŸèƒ½é€šè¿‡æ–°æ¥å£å®ç°
- æ€§èƒ½ç‰¹æ€§ä¿æŒæˆ–æå‡
- è°ƒåº¦è¡Œä¸ºå‘åå…¼å®¹

---

## å®ç°çŠ¶æ€ï¼ˆæ¸…ç†åï¼‰

### å·²å®Œæˆ âœ…
- [x] å®Œå…¨ç§»é™¤é‡å¤çš„æ—§å†å²è¡¨ç»“æ„
- [x] ç»Ÿä¸€åˆ°æ–°çš„ä¸‰å¤§æ•°æ®ç»“æ„
- [x] æ¸…ç†æ‰€æœ‰ç›¸å…³çš„æ—§å‡½æ•°å’Œå®å®šä¹‰
- [x] ç®€åŒ–åˆå§‹åŒ–å’Œæ¸…ç†æµç¨‹
- [x] ä»£ç é£æ ¼å’Œæ³¨é‡Šç»Ÿä¸€

### å½“å‰æ¶æ„ âœ…
- [x] åŠ é€Ÿè¡¨ï¼šå®Œæ•´å®ç°ï¼Œæ¥å£é½å…¨
- [x] å…¨å±€ä¼˜å…ˆé˜Ÿåˆ—ï¼šå®Œæ•´å®ç°ï¼Œæ¥å£é½å…¨  
- [x] CPUå†å²è¡¨ï¼šå®Œæ•´å®ç°ï¼Œæ¥å£é½å…¨
- [x] ç»Ÿä¸€çš„é”™è¯¯å¤„ç†å’Œå†…å­˜ç®¡ç†

### ä¸‹ä¸€æ­¥å®ç° ğŸš§
- [ ] å®ç°å®Œæ•´çš„ajlrè°ƒåº¦ç®—æ³•
- [ ] é›†æˆåŠ é€Ÿè¡¨åˆ°CPUé€‰æ‹©é€»è¾‘
- [ ] å®ç°benefitå€¼çš„åŠ¨æ€è®¡ç®—
- [ ] æ·»åŠ CRPæ¨¡å‹å’Œrecencyæ›´æ–°

---

**æ¸…ç†å®Œæˆ**: 2025å¹´7æœˆ16æ—¥  
**æ¶æ„çŠ¶æ€**: ç»Ÿä¸€ã€æ¸…æ™°ã€æ— å†—ä½™  
**å‡†å¤‡ç¨‹åº¦**: å¯å¼€å§‹å®ç°æ ¸å¿ƒè°ƒåº¦ç®—æ³•